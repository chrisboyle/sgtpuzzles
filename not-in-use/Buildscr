# -*- sh -*-
# Build script to build Puzzles.

module puzzles

set Version $(!builddate).$(vcsid)

# Start by substituting the right version number in configure.ac.
in puzzles do perl -i~ -pe 's/6.66/$(Version)/' configure.ac
in puzzles do rm configure.ac~

# And put it into the documentation as a versionid.
# use perl to avoid inconsistent behaviour of echo '\v'
in puzzles do perl -e 'print "\n\\versionid Simon Tatham'\''s Portable Puzzle Collection, version $$ARGV[0]\n"' $(Version) >> puzzles.but
in puzzles do perl -e 'print "\n\\versionid Simon Tatham'\''s Portable Puzzle Collection, version $$ARGV[0]\n"' $(Version) >> devel.but

# Write out a version.h that contains the real version number.
in puzzles do echo '/* Generated by automated build script */' > version.h
in puzzles do echo '$#define VER "Version $(Version)"' >> version.h

# And do the same substitution in the OS X metadata. (This is a bit
# icky in principle because it presumes that my version numbers don't
# need XML escaping, but frankly, if they ever do then I should fix
# them!)
in puzzles do perl -i -pe 's/Unidentified build/$(Version)/' osx-info.plist

# First build some local binaries, to run the icon build.
in puzzles do perl mkfiles.pl -U
in puzzles do make

# Now build the screenshots and icons.
in puzzles/icons do xvfb-run -s "-screen 0 1024x768x24" make web winicons gtkicons

# Destroy the local binaries and autoconf detritus, mostly to avoid
# wasting network bandwidth by transferring them to the delegate
# servers.
in puzzles do make distclean

# Re-run mkfiles.pl now that it knows the icons are there.
in puzzles do perl mkfiles.pl

# Rebuild the configure script.
in puzzles do ./mkauto.sh

# Build the OS X .dmg archive.
delegate osx
  in puzzles do make -f Makefile.osx clean
  in puzzles do make -f Makefile.osx release VER=-DVER=$(Version)
  return puzzles/Puzzles.dmg
enddelegate

# Build the Windows binaries and installer, and the CHM file.
in puzzles do make -f Makefile.doc clean
in puzzles do make -f Makefile.doc chm
in puzzles do make -f Makefile.doc # build help file for installer
in puzzles do perl winiss.pl $(Version) gamedesc.txt > puzzles.iss
delegate windows
  # Ignore the poorly controlled return value from HHC, and instead
  # just test that the output file was generated.
  in puzzles do/win hhc puzzles.hhp & type puzzles.chm >nul
  # FIXME: Cygwin alternative?
  in puzzles do/win vcvars32 && nmake -f Makefile.vc clean
  in puzzles do/win vcvars32 && nmake -f Makefile.vc VER=-DVER=$(Version)
  # Build installer.
  in puzzles do/win iscc puzzles.iss
  return puzzles/puzzles.chm
  return puzzles/*.exe
  return puzzles/Output/setup.exe
enddelegate
in puzzles do chmod +x *.exe

# Build the Pocket PC binaries and CAB.
#
# NOTE: This part of the build script requires the Windows delegate
# server to have the cabwiz program on its PATH. This will
# typically be at
#
#   C:\Program Files\Windows CE Tools\WCE420\POCKET PC 2003\Tools
#
# but it might not be if you've installed it somewhere else, or
# have a different version.
#
# NOTE ALSO: This part of the build is commented out, for the
# moment, because cabwiz does unhelpful things when run from within
# a bob delegate process (or, more generally, when run from any
# terminal-based remote login to a Windows machine, including
# Cygwin opensshd and Windows Telnet). The symptom is that cabwiz
# just beeps and sits there. Until I figure out how to build the
# .cab from an automated process (and I'm willing to consider silly
# approaches such as a third-party CAB generator), I don't think I
# can sensibly enable this build.

#in puzzles do perl wceinf.pl gamedesc.txt > puzzles.inf
#delegate windows
#  in puzzles do cmd /c 'wcearmv4 & nmake -f Makefile.wce clean'
#  in puzzles do cmd /c 'wcearmv4 & nmake -f Makefile.wce VER=-DVER=$(Version)'
#  # Nasty piece of sh here which saves the return code from cabwiz,
#  # outputs its errors and/or warnings, and then propagates the
#  # return code back to bob. If only cabwiz could output to
#  # standard error LIKE EVERY OTHER COMMAND-LINE UTILITY IN THE
#  # WORLD, I wouldn't have to do this.
#  in puzzles do cat puzzles.inf
#  in puzzles do cmd /c 'wcearmv4 & bash -c cabwiz puzzles.inf /err cabwiz.err /cpu ARMV4'; a=$$?; cat cabwiz.err; exit $$a
#  return puzzles/puzzles.armv4.cab
#enddelegate

# Build the help file and the HTML docs.
in puzzles do make -f Makefile.doc clean # remove CHM-target HTML
in puzzles do make -f Makefile.doc # and rebuild help file...
in puzzles do mkdir doc
in puzzles do mkdir devel
in puzzles/doc do halibut --html -Chtml-contents-filename:index.html -Chtml-index-filename:indexpage.html -Chtml-template-filename:%k.html -Chtml-template-fragment:%k ../puzzles.but
in puzzles/devel do halibut --html -Chtml-contents-filename:index.html -Chtml-index-filename:indexpage.html -Chtml-template-filename:%k.html -Chtml-template-fragment:%k ../devel.but

# Move the deliver-worthy Windows binaries (those specified in
# gamedesc.txt, which is generated by mkfiles.pl and helpfully
# excludes the command-line auxiliary utilities such as solosolver,
# and nullgame.exe) into a subdirectory for easy access.
in puzzles do mkdir winbin
in puzzles do mv `cut -f2 -d: gamedesc.txt` winbin

# Make a zip file of the Windows binaries and help files.
in puzzles do zip -j puzzles.zip winbin/*.exe puzzles.chm puzzles.hlp puzzles.cnt

# Create the source archive. (That writes the archive into the
# _parent_ directory, so be careful when we deliver it.)
in puzzles do ./makedist.sh $(Version)

# Build the autogenerated pieces of the main web page.
in puzzles do perl webpage.pl

ifneq "$(JAVA_UNFINISHED)" "" in puzzles do perl -i~ -pe 'print "!srcdir unfinished/\n" if /!srcdir icons/' Recipe
ifneq "$(JAVA_UNFINISHED)" "" in puzzles do ln -s unfinished/group.R .
ifneq "$(JAVA_UNFINISHED)" "" in puzzles do perl mkfiles.pl

# Build the Java applets.
delegate nestedvm
  in puzzles do make -f Makefile.nestedvm NESTEDVM="$$NESTEDVM" VER=-DVER=$(Version)
  return puzzles/*.jar
enddelegate

# Build the Javascript applets. Since my master build machine doesn't
# have the right dependencies installed for Emscripten, I do this by a
# delegation.
in puzzles do mkdir js # so we can tell output .js files from emcc*.js
delegate emscripten
  in puzzles do make -f Makefile.emcc OUTPREFIX=js/ clean
  in puzzles do make -f Makefile.emcc OUTPREFIX=js/
  return puzzles/js/*.js
enddelegate

# Set up .htaccess containing a redirect for the archive filename.
in puzzles do echo "AddType application/octet-stream .chm" > .htaccess
in puzzles do echo "AddType application/octet-stream .hlp" >> .htaccess
in puzzles do echo "AddType application/octet-stream .cnt" >> .htaccess
in . do set -- puzzles*.tar.gz; echo RedirectMatch temp '(.*/)'puzzles.tar.gz '$$1'"$$1" >> puzzles/.htaccess
in puzzles do echo RedirectMatch temp '(.*/)'puzzles-installer.exe '$$1'puzzles-$(Version)-installer.exe >> .htaccess

# Phew, we're done. Deliver everything!
deliver puzzles/icons/*-web.png $@
deliver puzzles/winbin/*.exe $@
deliver puzzles/.htaccess $@
deliver puzzles/doc/*.html doc/$@
deliver puzzles/devel/*.html devel/$@
deliver puzzles/Puzzles.dmg $@
deliver puzzles/puzzles.chm $@
deliver puzzles/puzzles.hlp $@
deliver puzzles/puzzles.cnt $@
deliver puzzles/puzzles.zip $@
deliver puzzles/Output/setup.exe puzzles-$(Version)-installer.exe
deliver puzzles/*.jar java/$@
deliver puzzles/js/*.js js/$@
deliver puzzles/html/*.html html/$@
deliver puzzles/html/*.pl html/$@
deliver puzzles/wwwspans.html $@
deliver puzzles/wwwlinks.html $@

# deliver puzzles/puzzles.armv4.cab $@ # (not built at the moment)

# This one isn't in the puzzles subdir, because makedist.sh left it
# one level up.
deliver puzzles*.tar.gz $@
