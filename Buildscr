# -*- sh -*-
# Build script to build Puzzles.

module puzzles

# First build some local binaries, to run the icon build.
in puzzles do perl mkfiles.pl
in puzzles do make

# Now build the screenshots and icons.
in puzzles/icons do xvfb-run -s "-screen 0 1024x768x24" make web winicons gtkicons

# Re-run mkfiles.pl now that it knows the icons are there.
in puzzles do perl mkfiles.pl

# Destroy the local binaries, mostly to avoid wasting network
# bandwidth by transferring them to the delegate servers.
in puzzles do make clean

# Build the OS X .dmg archive.
# 2012-04-03: commented out because my Mac is dead.
#delegate osx
#  in puzzles do make -f Makefile.osx clean
#  in puzzles do make -f Makefile.osx release VER=-DREVISION=$(revision)
#  return puzzles/Puzzles.dmg
#enddelegate

# Build the Windows binaries and installer, and the CHM file.
in puzzles do make -f Makefile.doc clean
in puzzles do make -f Makefile.doc chm
in puzzles do make -f Makefile.doc # build help file for installer
in puzzles do perl winiss.pl $(revision) gamedesc.txt > puzzles.iss
delegate windows
  # Ignore the poorly controlled return value from HHC, and instead
  # just test that the output file was generated.
  in puzzles do hhc puzzles.hhp; test -f puzzles.chm
  # FIXME: Cygwin alternative?
  in puzzles do cmd /c 'vcvars32 & nmake -f Makefile.vc clean'
  in puzzles do cmd /c 'vcvars32 & nmake -f Makefile.vc VER=-DREVISION=$(revision)'
  # Build installer.
  in puzzles do iscc puzzles.iss
  return puzzles/puzzles.chm
  return puzzles/*.exe
  return puzzles/Output/setup.exe
enddelegate
in puzzles do chmod +x *.exe

# Build the Pocket PC binaries and CAB.
#
# NOTE: This part of the build script requires the Windows delegate
# server to have the cabwiz program on its PATH. This will
# typically be at
#
#   C:\Program Files\Windows CE Tools\WCE420\POCKET PC 2003\Tools
#
# but it might not be if you've installed it somewhere else, or
# have a different version.
#
# NOTE ALSO: This part of the build is commented out, for the
# moment, because cabwiz does unhelpful things when run from within
# a bob delegate process (or, more generally, when run from any
# terminal-based remote login to a Windows machine, including
# Cygwin opensshd and Windows Telnet). The symptom is that cabwiz
# just beeps and sits there. Until I figure out how to build the
# .cab from an automated process (and I'm willing to consider silly
# approaches such as a third-party CAB generator), I don't think I
# can sensibly enable this build.

#in puzzles do perl wceinf.pl gamedesc.txt > puzzles.inf
#delegate windows
#  in puzzles do cmd /c 'wcearmv4 & nmake -f Makefile.wce clean'
#  in puzzles do cmd /c 'wcearmv4 & nmake -f Makefile.wce VER=-DREVISION=$(revision)'
#  # Nasty piece of sh here which saves the return code from cabwiz,
#  # outputs its errors and/or warnings, and then propagates the
#  # return code back to bob. If only cabwiz could output to
#  # standard error LIKE EVERY OTHER COMMAND-LINE UTILITY IN THE
#  # WORLD, I wouldn't have to do this.
#  in puzzles do cat puzzles.inf
#  in puzzles do cmd /c 'wcearmv4 & bash -c cabwiz puzzles.inf /err cabwiz.err /cpu ARMV4'; a=$$?; cat cabwiz.err; exit $$a
#  return puzzles/puzzles.armv4.cab
#enddelegate

# Build the help file and the HTML docs.
in puzzles do make -f Makefile.doc clean # remove CHM-target HTML
in puzzles do make -f Makefile.doc # and rebuild help file...
in puzzles do mkdir doc
in puzzles do mkdir devel
in puzzles/doc do halibut --html -Chtml-contents-filename:index.html -Chtml-index-filename:indexpage.html -Chtml-template-filename:%k.html -Chtml-template-fragment:%k ../puzzles.but
in puzzles/devel do halibut --html -Chtml-contents-filename:index.html -Chtml-index-filename:indexpage.html -Chtml-template-filename:%k.html -Chtml-template-fragment:%k ../devel.but

# Move the deliver-worthy Windows binaries (those specified in
# gamedesc.txt, which is generated by mkfiles.pl and helpfully
# excludes the command-line auxiliary utilities such as solosolver,
# and nullgame.exe) into a subdirectory for easy access.
in puzzles do mkdir winbin
in puzzles do mv `cut -f2 -d: gamedesc.txt` winbin

# Make a zip file of the Windows binaries and help files.
in puzzles do zip -j puzzles.zip winbin/*.exe puzzles.chm puzzles.hlp puzzles.cnt

# Create the source archive. (That writes the archive into the
# _parent_ directory, so be careful when we deliver it.)
in puzzles do ./makedist.sh $(revision)

ifneq "$(JAVA_UNFINISHED)" "" in puzzles do perl -i~ -pe 'print "!srcdir unfinished/\n" if /!srcdir icons/' Recipe
ifneq "$(JAVA_UNFINISHED)" "" in puzzles do ln -s unfinished/group.R .
ifneq "$(JAVA_UNFINISHED)" "" in puzzles do perl mkfiles.pl

# Build the Java applets. This requires .bob.conf on the master
# build machine to have defined the variable NESTEDVM pointing at
# the top-level directory of an installation of the NestedVM
# compiler and tools.
in puzzles do make -f Makefile.nestedvm NESTEDVM=$(NESTEDVM) VER=-DREVISION=$(revision)

# Build the Javascript applets. Since my master build machine doesn't
# have the right dependencies installed for Emscripten, I do this by a
# delegation.
in puzzles do mkdir js # so we can tell output .js files from emcc*.js
delegate emscripten
  in puzzles do make -f Makefile.emcc OUTPREFIX=js/ clean
  in puzzles do make -f Makefile.emcc OUTPREFIX=js/
  return puzzles/js/*.js
enddelegate

# Set up .htaccess containing a redirect for the archive filename.
in puzzles do echo "AddType application/octet-stream .chm" > .htaccess
in puzzles do echo "AddType application/octet-stream .hlp" >> .htaccess
in puzzles do echo "AddType application/octet-stream .cnt" >> .htaccess
in . do set -- puzzles*.tar.gz; echo RedirectMatch temp '(.*/)'puzzles.tar.gz '$$1'"$$1" >> puzzles/.htaccess
in puzzles do echo RedirectMatch temp '(.*/)'puzzles-installer.exe '$$1'puzzles-r$(revision)-installer.exe >> .htaccess

# Phew, we're done. Deliver everything!
deliver puzzles/icons/*-web.png $@
deliver puzzles/winbin/*.exe $@
deliver puzzles/.htaccess $@
deliver puzzles/doc/*.html doc/$@
deliver puzzles/devel/*.html devel/$@
#deliver puzzles/Puzzles.dmg $@ # 2012-04-03 commented out, see above
deliver puzzles/puzzles.chm $@
deliver puzzles/puzzles.hlp $@
deliver puzzles/puzzles.cnt $@
deliver puzzles/puzzles.zip $@
deliver puzzles/Output/setup.exe puzzles-r$(revision)-installer.exe
deliver puzzles/*.jar java/$@
deliver puzzles/js/*.js js/$@
deliver puzzles/html/*.html html/$@
deliver puzzles/html/*.pl html/$@

# deliver puzzles/puzzles.armv4.cab $@ # (not built at the moment)

# This one isn't in the puzzles subdir, because makedist.sh left it
# one level up.
deliver puzzles*.tar.gz $@
